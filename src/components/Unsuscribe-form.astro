<!-- Main Content -->
<section class="relative px-4 sm:px-10 py-20 lg:py-24">
    <div class="container mx-auto px-4 sm:px-6 max-w-4xl">
        <!-- Page Header -->
        <div class="text-center mb-8 animate-fade-in">
            <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold text-white mb-6">
                üìß <span class="gradient-text">Cancelar Suscripci√≥n</span>
            </h1>
            <p class="text-xl text-gray-300 max-w-3xl mx-auto mb-8">
                ¬°Oh no! üò¢ Nos entristece que quieras irte.
            </p>
            <p class="text-xl text-gray-300 max-w-3xl mx-auto">
                Antes de despedirnos, por favor verifica tu email para que
                podamos gestionar tu suscripci√≥n de forma segura.
            </p>
        </div>

        <!-- Main Form Container -->
        <div class="unsubscribe-card rounded-2xl p-8 animate-slide-up">
            <!-- Step 1: Email Verification -->
            <div id="step-email" class="step-container">
                <div class="text-center mb-8">
                    <div class="text-6xl mb-4">üìÆ</div>
                    <h2 class="text-2xl font-bold text-white mb-4">
                        Verificar Email
                    </h2>
                    <p class="text-gray-300">
                        Introduce tu direcci√≥n de correo y confirma tu decisi√≥n.
                    </p>
                </div>

                <form id="unsuscribe-form" class="space-y-6">
                    <div>
                        <label for="email" class="block text-white font-medium mb-2">
                            üìß Direcci√≥n de Email
                        </label>
                        <input type="email" id="email" name="email" autocomplete="off" required
                            placeholder="JohnDoe@email.com"
                            class="w-full px-4 py-3 bg-white/20 bg-opacity-10 border border-white border-opacity-20 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300" />
                        <div id="email-error" class="hidden text-red-300 text-sm mt-2">
                        </div>
                    </div>
                    <button type="submit"
                        class="w-full px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-500 text-white font-semibold rounded-xl hover:scale-105 transform transition-all duration-300 flex items-center justify-center space-x-2 outline-none">
                        <span>Cancelar Suscripci√≥n</span>
                    </button>
                    <!-- Error Message -->
                    <p id="message2" class="text-center text-sm mt-2"></p>
                </form>
            </div>

            <!-- Step 3: Confirmation -->
            <div id="step-confirmation" class="step-container hidden">
                <div class="text-center">
                    <div class="text-8xl mb-6 success-animation">‚úÖ</div>
                    <h2 class="text-3xl font-bold text-white mb-4">
                        ¬°Suscripciones Canceladas!
                    </h2>
                    <p class="text-xl text-gray-300 mb-8">
                        Hemos procesado tu solicitud correctamente
                    </p>

                    <!-- Summary -->
                    <div class="bg-white bg-opacity-5 rounded-xl p-6 mb-8 text-left">
                        <h3 class="text-lg font-semibold text-white mb-4">
                            üìã Resumen de Cambios:
                        </h3>
                        <div id="unsubscribe-summary" class="space-y-2 text-gray-300">
                            <!-- Summary will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- What happens next -->
                    <div class="bg-blue-500 bg-opacity-20 border border-blue-500 border-opacity-30 rounded-xl p-6 mb-8">
                        <h3 class="text-lg font-semibold text-blue-200 mb-3">
                            üîÆ ¬øQu√© sucede ahora?
                        </h3>
                        <ul class="text-blue-300 text-sm space-y-2 text-left">
                            <li>‚Ä¢ Los cambios son efectivos inmediatamente</li>
                            <li>
                                ‚Ä¢ Podr√≠as recibir emails ya programados en las
                                pr√≥ximas 24-48 horas
                            </li>
                            <li>
                                ‚Ä¢ Puedes reactivar tus suscripciones en
                                cualquier momento
                            </li>
                            <li>
                                ‚Ä¢ Los emails transaccionales (facturas,
                                seguridad) continuar√°n llegando
                            </li>
                        </ul>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button onclick="goToHomepage()"
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-500 text-white font-semibold rounded-xl hover:scale-105 transform transition-all duration-300">
                            üè† Ir al Inicio
                        </button>
                        <button onclick="resubscribe()"
                            class="flex-1 px-6 py-3 bg-green-600 bg-opacity-50 text-white font-semibold rounded-xl hover:bg-opacity-70 transition-all duration-300">
                            üîÑ Reactivar Suscripciones
                        </button>
                    </div>

                    <!-- Contact Support -->
                    <div class="mt-8 pt-6 border-t border-white border-opacity-20">
                        <p class="text-gray-400 text-sm mb-4">
                            ¬øNecesitas ayuda o tienes alguna pregunta?
                        </p>
                        <button onclick="contactSupport()"
                            class="px-4 py-2 bg-white bg-opacity-10 text-white rounded-lg hover:bg-opacity-20 transition-colors">
                            üí¨ Contactar Soporte
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loader -->
    <div id="loaderModal"
        class="hidden opacity-0 fixed inset-0 z-[70] flex items-center justify-center bg-black/70 backdrop-blur-sm transition-opacity duration-200"
        role="dialog" aria-modal="true" aria-labelledby="loaderTitle">
        <div class="mx-4 w-full max-w-sm rounded-2xl border border-white/20 bg-white/10 p-6 text-center shadow-xl">
            <div
                class="mx-auto mb-4 h-12 w-12 rounded-full border-4 border-blue-400/40 border-t-transparent animate-spin">
            </div>
            <h2 id="loaderTitle" class="text-white text-lg font-semibold mb-1">
                Procesando
            </h2>
            <p data-loader-text class="text-gray-200 text-sm">
                Por favor, espera un momento...
            </p>
        </div>
    </div>
</section>

<!-- JavaScript -->
<script>

    window.addEventListener('load', () => {

        const form = document.getElementById("unsuscribe-form");

        if (!form) return; // Evita el error de null

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const emailInput = document.getElementById("email") as HTMLInputElement;

            // Show loading state
            const button = document.querySelector<HTMLButtonElement>('button[type="submit"]');
            const messageEl = document.getElementById("message2");

            if (!button||!messageEl) return;

            showLoader();
            const originalText = button.innerHTML;
            button.innerHTML =
                '<span class="flex items-center justify-center space-x-2"><span class="animate-spin">‚è≥</span><span>Procesando...</span></span>';
            button.disabled = true;

            if(!emailInput.value){
                messageEl.textContent = "Email obligatorio";
                messageEl.className =
                    "text-red-300 text-center text-sm bg-red-500/20 p-4 rounded-xl border border-red-400/30";
                button.innerHTML = originalText;
                button.disabled = false;
                hideLoader();
                return;
            }

            const res = await unsubscribe_api(originalText, emailInput.value);
        });
    })


    async function getToken() {
        const res = await fetch(`${import.meta.env.PUBLIC_API}/token`);

        if (!res.ok) {
            return false
        }

        const data = await res.json();
        return data.token; // O la propiedad que te env√≠e el token
    }


    async function unsubscribe_api(originalText:string, data_email:any) {
        const token = await getToken();
        const button = document.querySelector<HTMLButtonElement>('button[type="submit"]');
        const messageEl = document.getElementById("message2");
        if (!button ||!messageEl) return;

        if (!token) {
            messageEl.textContent = "Ocurri√≥ un error, intentarlo m√°s tarde";
            messageEl.className =
                "text-red-300 text-center text-sm bg-red-500/20 p-4 rounded-xl border border-red-400/30";
            button.innerHTML = originalText;
            button.disabled = false;
            hideLoader();
            return;
        }


        const res = await fetch(
            `${import.meta.env.PUBLIC_API}/unsuscribe`,
            {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({
                    email: data_email
                }),
            },
        );
        const data = await res.json();
        if (!res.ok) {
            messageEl.textContent = data.detail;
            messageEl.className =
                "text-red-300 text-center text-sm bg-red-500/20 p-4 rounded-xl border border-red-400/30";
            button.innerHTML = originalText;
            button.disabled = false;
            hideLoader();
            return;
        }

        if (data.error) {
            messageEl.textContent = data.error;
            messageEl.className =
                "text-red-300 text-center text-sm bg-red-500/20 p-4 rounded-xl border border-red-400/30";
            button.innerHTML = originalText;
            button.disabled = false;
            hideLoader();
            return;
        } else {
            messageEl.textContent = data.message;
            messageEl.className = "text-green-600 text-center text-sm";
            button.innerHTML = originalText;
            button.disabled = false;
            hideLoader();
        }
    }

    
    function showLoader(message = "Procesando solicitud...") {
        const modal = document.getElementById("loaderModal") as HTMLDivElement;
        const label = modal.querySelector("[data-loader-text]");
        if (label) label.textContent = message;

        modal.classList.remove("hidden");
        requestAnimationFrame(() => {
            modal.classList.remove("opacity-0");
        });

        // Bloquea el scroll de fondo
        document.body.classList.add("overflow-hidden");
    }

    function hideLoader() {
        const modal = document.getElementById("loaderModal") as HTMLDivElement;
        modal.classList.add("opacity-0");
        setTimeout(() => {
            modal.classList.add("hidden");
            document.body.classList.remove("overflow-hidden");
        }, 200); // sincronizado con transition-opacity
    }
</script>
