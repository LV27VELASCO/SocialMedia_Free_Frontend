---
import { useI18n } from '../../i18n';
const { translate, currentLang } = useI18n(Astro);
---

<div id="paymentModal"
    class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-black/50 backdrop-blur-sm overflow-y-auto">
    <div class="mx-4 my-8 h-[90%] overflow-y-scroll w-full max-w-2xl bg-white/10 backdrop-blur-lg rounded-2xl border border-white/20 p-8 animate-scale-in">
        <input id="lang" type="hidden" value={currentLang}>
        <!-- Added close button in top-right corner -->
        <button onclick="closePaymentModal()"
            class="close-button absolute top-4 right-4 w-10 h-10 flex items-center justify-center rounded-full bg-white/10 hover:bg-red-500/20 border border-white/20 hover:border-red-400 text-white hover:text-red-400 text-xl font-bold transition-all z-10"
            aria-label="Cerrar modal">
            √ó
        </button>
        
        <!-- Modal Header -->
        <div class="text-center mb-8">
            <div class="text-6xl mb-4">üí≥</div>
            <h2 class="text-3xl font-bold text-white mb-2">{translate('social.modal.payment.title')}</h2>
            <p class="text-gray-300">
                {translate('social.modal.payment.subtitle')}
            </p>
        </div>

        <form id="payment-form" class="space-y-6">
            <!-- Order Summary -->
            <div class="bg-white/5 rounded-xl p-6">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                    <span class="mr-3">üìã</span>
                    {translate('social.modal.payment.banner.b1.title')}
                </h3>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl" id="payment-platform-icon">üéµ</span>
                            <div>
                                <div class="text-white font-medium" id="payment-username">
                                    @usuario
                                </div>
                                <div class="text-gray-300 text-sm" id="payment-platform">
                                    TikTok
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-white font-bold" id="payment-followers">
                                1,000 Seguidores
                            </div>
                            <div class="text-green-300 text-sm" id="payment-price">
                                GRATIS
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Notice -->
            <div class="bg-green-500/20 border border-green-500/30 rounded-xl p-4">
                <div class="flex items-start space-x-3">
                    <span class="text-2xl">üîí</span>
                    <div>
                        <h4 class="text-green-200 font-semibold mb-2">
                            {translate('social.modal.payment.banner.b2.title')}
                        </h4>
                        
                        <ul class="text-green-300 text-sm space-y-1">
                            <div id="pay-verify" class="hidden">
                                <li>‚Ä¢ {translate('social.modal.payment.banner.b2.p1')}</li>
                                <li>‚Ä¢ {translate('social.modal.payment.banner.b2.p2')}</li>
                            </div>
                            <li>‚Ä¢ {translate('social.modal.payment.banner.b2.p3')}</li>
                            <li>‚Ä¢ {translate('social.modal.payment.banner.b2.p4')}</li>
                            <li>‚Ä¢ {translate('social.modal.payment.banner.b2.p5')}</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Card Information -->
            <div class="bg-white/5 rounded-xl p-6">
                <h3 class="text-xl font-bold text-white mb-6 flex items-center">
                    <span class="mr-3">üí≥</span>
                    {translate('social.modal.payment.banner.form.title')}
                </h3>

                <div class="space-y-4">
                    <!-- Card Number -->
                    <div>
                        <label for="card-number" class="block text-white font-medium mb-2">
                            {translate('social.modal.payment.banner.form.number')}
                        </label>
                        <div class="relative">
                            <div id="card-number"
                                class="w-full px-4 py-3 bg-white/40 border border-white/30 rounded-xl text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300">
                            </div>
                            <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                                <div id="cardType" class="text-2xl">üí≥</div>
                            </div>
                        </div>
                    </div>

                    <!-- Expiry and CVV -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label for="card-expiry" class="block text-white font-medium mb-2">
                                {translate('social.modal.payment.banner.form.caducate')}
                            </label>
                            <div id="card-expiry"
                                class="w-full px-4 py-3 bg-white/40 border border-white/30 rounded-xl text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300">
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label for="card-cvc" class="block text-white font-medium mb-2">
                                {translate('social.modal.payment.banner.form.ccv')}
                            </label>
                            <div id="card-cvc"
                                class="w-full px-4 py-3 bg-white/40 border border-white/30 rounded-xl text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300">
                            </div>
                        </div>
                    </div>

                    <!-- Cardholder Name -->
                    <div>
                        <label for="card-name" class="block text-white font-medium mb-2">
                           {translate('social.modal.payment.banner.form.name')}
                        </label>
                        <input type="text" id="card-name" name="card-name" placeholder="John Doe"
                            class="w-full px-4 py-3 bg-white/40 border border-white/30 rounded-xl text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300"
                            required />
                    </div>
                </div>
            </div>

            <!-- Terms and Conditions -->
            <div class="bg-white/5 rounded-xl p-6">
                <div class="flex items-start space-x-4">
                    <input type="checkbox" id="acceptTerms" name="acceptTerms" class="checkbox-custom mt-1" required />
                    <div class="flex-1">
                        <label for="acceptTerms" class="text-white font-medium cursor-pointer">
                            {translate('social.modal.payment.banner.form.check.title')}
                        </label>
                        <p class="text-gray-300 text-sm mt-2">
                            {translate('social.modal.payment.banner.form.check.p1')}
                            <a href={`/${currentLang}/terms`} target="_blank" class="text-blue-300 hover:text-blue-200 underline">{translate('social.modal.payment.banner.form.check.p2')}</a> {translate('social.modal.payment.banner.form.check.p3')} 
                            <a href={`/${currentLang}/privacity`} target="_blank" class="text-blue-300 hover:text-blue-200 underline">{translate('social.modal.payment.banner.form.check.p4')}</a>.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Total -->
            <div class="bg-white/10 rounded-xl p-6 border border-white/20">
                <div class="flex justify-between items-center">
                    <div>
                        <h4 class="text-white font-semibold text-lg">
                           {translate('social.modal.payment.banner.b3.title')}
                        </h4>
                        <p id="pay-verify" class="hidden text-gray-300 text-sm">{translate('social.modal.payment.banner.b3.subtitle')}</p>
                    </div>
                    <div class="text-right">
                        <div id="total-pay" class="text-2xl font-bold text-white">
                            ‚Ç¨1.00
                        </div>
                        <div id="pay-verify" class="hidden text-green-300 text-sm">{translate('social.modal.payment.banner.b3.span')}</div>
                    </div>
                </div>
                <div class="flex justify-around items-center flex-wrap mt-4 gap-2">
                    <div
                        class="flex items-center text-white text-xs px-3 py-1 bg-gradient-to-r from-blue-500/30 via-purple-500/30 to-indigo-500/30 text-white rounded-md">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="size-4">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 12.75 11.25 15 15 9.75m-3-7.036A11.959 11.959 0 0 1 3.598 6 11.99 11.99 0 0 0 3 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285Z">
                            </path>
                        </svg>
                        <p class="pl-1">{translate('social.modal.payment.banner.span.p1')}</p>
                    </div>
                    <div
                        class="flex items-center text-white text-xs px-3 py-1 bg-gradient-to-r from-blue-500/30 via-purple-500/30 to-indigo-500/30 rounded-md">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="size-4">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z">
                            </path>
                        </svg>
                        <p class="pl-1">{translate('social.modal.payment.banner.span.p2')}</p>
                    </div>
                    <div
                        class="flex items-center text-white text-xs px-3 py-1 bg-gradient-to-r from-blue-500/30 via-purple-500/30 to-indigo-500/30 rounded-md">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="size-4">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M6.633 10.25c.806 0 1.533-.446 2.031-1.08a9.041 9.041 0 0 1 2.861-2.4c.723-.384 1.35-.956 1.653-1.715a4.498 4.498 0 0 0 .322-1.672V2.75a.75.75 0 0 1 .75-.75 2.25 2.25 0 0 1 2.25 2.25c0 1.152-.26 2.243-.723 3.218-.266.558.107 1.282.725 1.282m0 0h3.126c1.026 0 1.945.694 2.054 1.715.045.422.068.85.068 1.285a11.95 11.95 0 0 1-2.649 7.521c-.388.482-.987.729-1.605.729H13.48c-.483 0-.964-.078-1.423-.23l-3.114-1.04a4.501 4.501 0 0 0-1.423-.23H5.904m10.598-9.75H14.25M5.904 18.5c.083.205.173.405.27.602.197.4-.078.898-.523.898h-.908c-.889 0-1.713-.518-1.972-1.368a12 12 0 0 1-.521-3.507c0-1.553.295-3.036.831-4.398C3.387 9.953 4.167 9.5 5 9.5h1.053c.472 0 .745.556.5.96a8.958 8.958 0 0 0-1.302 4.665c0 1.194.232 2.333.654 3.375Z">
                            </path>
                        </svg>
                        <p class="pl-1">{translate('social.modal.payment.banner.span.p3')}</p>
                    </div>
                </div>
            </div>

            <div id="errorMessage"
                class="hidden text-red-300 text-sm bg-red-500/20 p-4 rounded-xl border border-red-400/30">
            </div>

            <div id="SuccessMessage"
                class="hidden text-green-300 text-sm bg-green-500/20 p-4 rounded-xl border border-green-400/30">
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-4 pt-4">
                <button type="button" onclick="backToFollowersModal()"
                    class="flex-1 px-6 py-3 bg-gray-600/50 text-white font-semibold rounded-xl hover:bg-opacity-70 transition-all duration-300">
                    ‚Üê {translate('social.modal.payment.button.prev')}
                </button>
                <button id="btn-pay" type="submit"
                    class="flex-1 px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold rounded-xl hover:scale-105 transform transition-all duration-300 shadow-2xl">
                    üí≥ {translate('social.modal.payment.button.next')}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    if (!window.Stripe) {
        const script = document.createElement("script");
        script.src = "https://js.stripe.com/v3/";
        script.async = true;
        document.head.appendChild(script);
    }
</script>
<!-- Logica Pagos -->
<script>
    // === Sistema de traducciones ===
    const MESSAGES:any = {
        validating_card: {
            es: "Validando tarjeta...",
            en: "Validating card...",
            fr: "Validation de la carte...",
            pt: "Validando cart√£o...",
            de: "Karte wird √ºberpr√ºft..."
        },
        accept_terms: {
            es: "üö® Debes aceptar los t√©rminos",
            en: "üö® You must accept the terms",
            fr: "üö® Vous devez accepter les conditions",
            pt: "üö® Voc√™ deve aceitar os termos",
            de: "üö® Sie m√ºssen die Bedingungen akzeptieren"
        },
        card_name_required: {
            es: "üö® El nombre del titular es requerido",
            en: "üö® Cardholder name is required",
            fr: "üö® Le nom du titulaire est requis",
            pt: "üö® O nome do titular √© obrigat√≥rio",
            de: "üö® Der Name des Karteninhabers ist erforderlich"
        },
        token_error: {
            es: "¬°Ups! Ocurri√≥ un error, por favor int√©ntalo m√°s tarde",
            en: "Oops! An error occurred, please try again later",
            fr: "Oups ! Une erreur s‚Äôest produite, veuillez r√©essayer plus tard",
            pt: "Opa! Ocorreu um erro, tente novamente mais tarde",
            de: "Ups! Ein Fehler ist aufgetreten, bitte versuchen Sie es sp√§ter erneut"
        },
        loader_text: {
            es: "Este proceso puede tardar algunos minutos. Por favor, espere mientras completamos la operaci√≥n.",
            en: "This process may take a few minutes. Please wait while we complete the operation.",
            fr: "Ce processus peut prendre quelques minutes. Veuillez patienter pendant que nous terminons l‚Äôop√©ration.",
            pt: "Este processo pode levar alguns minutos. Por favor, aguarde enquanto conclu√≠mos a opera√ß√£o.",
            de: "Dieser Vorgang kann einige Minuten dauern. Bitte warten Sie, w√§hrend wir die Operation abschlie√üen."
        },
        // üÜï Mensajes a√±adidos para el nuevo flujo:
        payment_pending: {
            es: "El pago est√° pendiente. Por favor, completa la autenticaci√≥n si es necesario.",
            en: "The payment is pending. Please complete authentication if required.",
            fr: "Le paiement est en attente. Veuillez terminer l‚Äôauthentification si n√©cessaire.",
            pt: "O pagamento est√° pendente. Conclua a autentica√ß√£o se necess√°rio.",
            de: "Die Zahlung ist ausstehend. Bitte schlie√üen Sie die Authentifizierung ab, falls erforderlich."
        },
        payment_failed: {
            es: "‚ùå El pago no se complet√≥. Por favor, revisa tu tarjeta o intenta nuevamente.",
            en: "‚ùå Payment could not be completed. Please check your card or try again.",
            fr: "‚ùå Le paiement n‚Äôa pas pu √™tre effectu√©. Veuillez v√©rifier votre carte ou r√©essayer.",
            pt: "‚ùå O pagamento n√£o p√¥de ser conclu√≠do. Verifique seu cart√£o ou tente novamente.",
            de: "‚ùå Die Zahlung konnte nicht abgeschlossen werden. Bitte √ºberpr√ºfen Sie Ihre Karte oder versuchen Sie es erneut."
        },
        success_purchase: {
            es: "‚úÖ ¬°Pago realizado con √©xito! Procesando tu pedido...",
            en: "‚úÖ Payment successful! Processing your order...",
            fr: "‚úÖ Paiement r√©ussi ! Traitement de votre commande...",
            pt: "‚úÖ Pagamento realizado com sucesso! Processando seu pedido...",
            de: "‚úÖ Zahlung erfolgreich! Ihre Bestellung wird bearbeitet..."
        },
        trial_used: {
            es: "üö´ Ya has usado la prueba gratuita con esta tarjeta.",
            en: "üö´ You have already used the free trial with this card.",
            fr: "üö´ Vous avez d√©j√† utilis√© l‚Äôessai gratuit avec cette carte.",
            pt: "üö´ Voc√™ j√° usou o teste gratuito com este cart√£o.",
            de: "üö´ Sie haben das kostenlose Probeangebot mit dieser Karte bereits genutzt."
        },
        price_invalid: {
            es: "‚ùå El precio del producto no es v√°lido.",
            en: "‚ùå The product price is invalid.",
            fr: "‚ùå Le prix du produit est invalide.",
            pt: "‚ùå O pre√ßo do produto √© inv√°lido.",
            de: "‚ùå Der Produktpreis ist ung√ºltig."
        }
    };

    const URL_SERVICE:any = {
        "instagram": "https://www.instagram.com/",
        "tiktok": "https://www.tiktok.com/@"
    }


    // Obtener idioma (de input o navegador)
    const langInput = document.getElementById("lang") as HTMLInputElement;
    const locale = langInput?.value.trim();

    function getMessage(key:any, lang = locale) {
        return MESSAGES[key]?.[lang] || MESSAGES[key]?.["en"] || "";
    }

    // === Configuraci√≥n de Stripe ===
    window.addEventListener("load", () => {
        const stripe = Stripe(import.meta.env.PUBLIC_STRIPE_PK);

        const appearance = {
            theme: "night",
            variables: {
                fontFamily: "Sohne, system-ui, sans-serif",
                fontWeightNormal: "500",
                borderRadius: "8px",
                colorBackground: "#0A2540",
                colorPrimary: "#EFC078",
                accessibleColorOnColorPrimary: "#1A1B25",
                colorText: "white",
                colorTextSecondary: "white",
                colorTextPlaceholder: "#ABB2BF",
                tabIconColor: "white",
                logoColor: "dark",
            },
            rules: {
                ".Input": {
                    backgroundColor: "#212D63",
                    border: "1px solid var(--colorPrimary)",
                },
            },
        };

        const elements = stripe.elements({
            appearance,
            locale
        });

        const cardNumber = elements.create("cardNumber");
        cardNumber.mount("#card-number");
        const cardExpiry = elements.create("cardExpiry");
        cardExpiry.mount("#card-expiry");
        const cardCvc = elements.create("cardCvc");
        cardCvc.mount("#card-cvc");

        const errormessage = document.getElementById("errorMessage");
        if (!errormessage) return;
        errormessage.classList.add("hidden");

        const form = document.getElementById("payment-form") as HTMLFormElement;
        if (!form) return;

        form.addEventListener("submit", async (e:any) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const orderData = JSON.parse(localStorage.getItem("orderData") as string);;

            const button = document.querySelector<HTMLButtonElement>("#btn-pay");;
            if (!button) return;

            showLoader();
            const originalText = button.innerHTML;
            button.innerHTML =
                `<span class="flex items-center justify-center space-x-2"><span class="animate-spin">‚è≥</span><span>${getMessage("validating_card")}</span></span>`;
            button.disabled = true;

            // Validar aceptaci√≥n de t√©rminos
            if (!formData.get("acceptTerms")) {
                showError(errormessage, getMessage("accept_terms"));
                resetButton(button, originalText);
                return;
            }

            // Validar nombre del titular
            if (!formData.get("card-name")) {
                showError(errormessage, getMessage("card_name_required"));
                resetButton(button, originalText);
                return;
            }

            // Crear m√©todo de pago con Stripe
            const { paymentMethod, error } = await stripe.createPaymentMethod({
                type: "card",
                card: cardNumber,
            });

            if (error) {
                showError(errormessage, `üö® ${error.message}`);
                resetButton(button, originalText);
                return;
            }

            // Continuar con checkout
            await checkout_product(stripe,paymentMethod, originalText, formData.get("card-name")?.toString());
        });
    });

    // === Funci√≥n para obtener token ===
    async function getToken() {
        try {
            const res = await fetch(`${import.meta.env.PUBLIC_API}/token`);
            if (!res.ok) return false;
            const data = await res.json();
            return data.token;
        } catch (err) {
            console.error("Error en getToken:", err);
            return false;
        }
    }

    // === Checkout con el backend ===
    async function checkout_product(stripe:any, paymentMethod: any, originalText: any, cardName: any) {
        const token = await getToken();
        const orderData = JSON.parse(localStorage.getItem("orderData") as string);
        const button = document.querySelector("#btn-pay");
        const errormessage = document.getElementById("errorMessage");
        const successmessage = document.getElementById("SuccessMessage");

        if (!button || !errormessage || !successmessage) return;

        successmessage.classList.add("hidden");
        errormessage.classList.add("hidden");

        if (!token) {
            showError(errormessage, getMessage("token_error"));
            resetButton(button, originalText);
            return;
        }

        let platform = orderData.platform.toLowerCase().trim();
        let username = orderData.username.toLowerCase().trim();

        const res = await fetch(`${import.meta.env.PUBLIC_API}/checkout`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
                paymentMethodId: paymentMethod.id,
                cardName: cardName.toLowerCase().trim(),
                username: username,
                email: orderData.email.toLowerCase().trim(),
                platform: platform,
                quantity: orderData.followers,
                locale
            }),
        });

        const data = await res.json();

        if (!res.ok || data.error) {
            showError(errormessage, data.error || getMessage("token_error"));
            resetButton(button, originalText);
            return;
        }

        // 2Ô∏è‚É£ Confirmar el pago con Stripe.js
        const { error, paymentIntent } = await stripe.confirmCardPayment(data.clientSecret, {
            payment_method: paymentMethod.id,
        });

        if (error) {
            showError(errormessage, error.message || getMessage("payment_failed"));
            resetButton(button, originalText);
            return;
        }

        if (paymentIntent.status === "succeeded") {
            (document.getElementById("formFollowers") as HTMLFormElement).reset();
            let urlProfile = URL_SERVICE[platform] + username
            localStorage.setItem("url", urlProfile);
            successmessage.classList.remove("hidden");
            successmessage.textContent = getMessage("success_purchase");
            resetButton(button, originalText);

            // 3Ô∏è‚É£ Opcional: redirigir tras confirmaci√≥n visual
            setTimeout(() => {
                window.location.href = `/${locale}/confirmation-success`;
            }, 2000);
        } else {
            showError(errormessage, getMessage("payment_pending"));
        }
    }

    // === Utilidades ===
    function showError(element:any, message:any) {
        element.textContent = message;
        element.classList.remove("hidden");
        element.classList.add(
            "text-red-300",
            "text-sm",
            "bg-red-500/20",
            "p-4",
            "rounded-xl",
            "border",
            "border-red-400/30"
        );
        hideLoader();
    }

    function resetButton(button:any, text:any) {
        button.innerHTML = text;
        button.disabled = false;
        hideLoader();
    }

    function showLoader(message = getMessage("loader_text")) {
        const modal = document.getElementById("loaderModal");
        const label = modal?.querySelector("[data-loader-text]");
        if (label) label.textContent = message;
        modal?.classList.remove("hidden");
        requestAnimationFrame(() => modal?.classList.remove("opacity-0"));
        document.body.classList.add("overflow-hidden");
    }

    function hideLoader() {
        const modal = document.getElementById("loaderModal");
        modal?.classList.add("opacity-0");
        setTimeout(() => {
            modal?.classList.add("hidden");
            document.body.classList.remove("overflow-hidden");
        }, 200);
    }
</script>

